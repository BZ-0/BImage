const s=(()=>{var t,e=new Array(256);for(let i=0;256!=i;++i)t=1&(t=1&(t=1&(t=1&(t=1&(t=1&(t=1&(t=i)?-306674912^t>>>1:t>>>1)?-306674912^t>>>1:t>>>1)?-306674912^t>>>1:t>>>1)?-306674912^t>>>1:t>>>1)?-306674912^t>>>1:t>>>1)?-306674912^t>>>1:t>>>1)?-306674912^t>>>1:t>>>1,e[i]=1&t?-306674912^t>>>1:t>>>1;return"undefined"!=typeof Int32Array?new Int32Array(e):e})();var t=(t=>{let e=0,i=0,r=0;var a=new("undefined"!=typeof Int32Array?Int32Array:Array)(4096);for(r=0;256!=r;++r)a[r]=t[r];for(r=0;256!=r;++r)for(i=t[r],e=256+r;e<4096;e+=256)i=a[e]=i>>>8^t[255&i];var s=[];for(r=1;16!=r;++r)s[r-1]="undefined"!=typeof Int32Array?a.subarray(256*r,256*r+256):a.slice(256*r,256*r+256);return s})(s);const h=t[0],n=t[1],l=t[2],o=t[3],g=t[4],c=t[5],R=t[6],f=t[7],u=t[8],d=t[9],E=t[10],A=t[11],w=t[12],U=t[13],T=t[14],e=(t,e,i)=>{var r=t.createShader(i),a=(t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS));if(a)return r;throw"could not compile shader:"+t.getShaderInfoLog(r)},a=(t,e)=>({[t.R8UI]:t.UNSIGNED_BYTE,[t.RG8UI]:t.UNSIGNED_BYTE,[t.RGB8UI]:t.UNSIGNED_BYTE,[t.RGBA8UI]:t.UNSIGNED_BYTE,[t.R16UI]:t.UNSIGNED_SHORT,[t.RG16UI]:t.UNSIGNED_SHORT,[t.RGB16UI]:t.UNSIGNED_SHORT,[t.RGBA16UI]:t.UNSIGNED_SHORT,[t.R32UI]:t.UNSIGNED_INT,[t.RG32UI]:t.UNSIGNED_INT,[t.RGB32UI]:t.UNSIGNED_INT,[t.RGBA32UI]:t.UNSIGNED_INT,[t.R8]:t.UNSIGNED_BYTE,[t.RG8]:t.UNSIGNED_BYTE,[t.RGB8]:t.UNSIGNED_BYTE,[t.RGBA8]:t.UNSIGNED_BYTE,[t.SRGB8]:t.UNSIGNED_BYTE,[t.SRGB8_ALPHA8]:t.UNSIGNED_BYTE,[t.SRGB_ALPHA]:t.UNSIGNED_BYTE,[t.SRGB]:t.UNSIGNED_BYTE,[t.R16]:t.UNSIGNED_SHORT,[t.RG16]:t.UNSIGNED_SHORT,[t.RGB16]:t.UNSIGNED_SHORT,[t.RGBA16]:t.UNSIGNED_SHORT,[t.R32]:t.UNSIGNED_INT,[t.RG32]:t.UNSIGNED_INT,[t.RGB32]:t.UNSIGNED_INT,[t.RGBA32]:t.UNSIGNED_INT,[t.R32F]:t.FLOAT,[t.RG32F]:t.FLOAT,[t.RGB32F]:t.FLOAT,[t.RGBA32F]:t.FLOAT})[e],m=(t,e)=>({[t.SRGB8]:t.RGB,[t.SRGB8_ALPHA8]:t.RGBA,[t.SRGB_ALPHA]:t.RGBA,[t.SRGB]:t.RGB,[t.R8UI]:t.RED_INTEGER,[t.RG8UI]:t.RG_INTEGER,[t.RGB8UI]:t.RGB_INTEGER,[t.RGBA8UI]:t.RGBA_INTEGER,[t.R16UI]:t.RED_INTEGER,[t.RG16UI]:t.RG_INTEGER,[t.RGB16UI]:t.RGB_INTEGER,[t.RGBA16UI]:t.RGBA_INTEGER,[t.R32UI]:t.RED_INTEGER,[t.RG32UI]:t.RG_INTEGER,[t.RGB32UI]:t.RGB_INTEGER,[t.RGBA32UI]:t.RGBA_INTEGER,[t.R8]:t.RED,[t.RG8]:t.RG,[t.RGB8]:t.RGB,[t.RGBA8]:t.RGBA,[t.R16]:t.RED,[t.RG16]:t.RG,[t.RGB16]:t.RGB,[t.RGBA16]:t.RGBA,[t.R32]:t.RED,[t.RG32]:t.RG,[t.RGB32]:t.RGB,[t.RGBA32]:t.RGBA,[t.R32F]:t.RED,[t.RG32F]:t.RG,[t.RGB32F]:t.RGB,[t.RGBA32F]:t.RGBA})[e],i="srgb-linear",r={gamma:1/2.2,rxy:new Float32Array([.64,.33]),gxy:new Float32Array([.3,.6]),bxy:new Float32Array([.15,.06]),wxy:new Float32Array([.3127,.329])};class G{constructor(){this.canvas=new OffscreenCanvas(2,2),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!1,preserveDrawingBuffer:!0,alpha:!0,depth:!1,precision:"highp",antialias:!1,powerPreference:"high-performance",desynchronized:!0,willReadFrequently:!0,colorSpace:i,pixelFormat:"float16",dataType:"float16",colorType:"float16"}),this.canvas?.configureHighDynamicRange?.({mode:"extended"}),this.correction={...r},this.unorm16=this.gl.getExtension("EXT_texture_norm16"),this.float32=this.gl.getExtension("EXT_color_buffer_float"),this.float16=this.gl.getExtension("EXT_color_buffer_half_float"),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.pixelStorei(this.gl.PACK_ALIGNMENT,1),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.CULL_FACE),this.gl.disable(this.gl.DEPTH_TEST),this.gl.bindVertexArray(this.gl.createVertexArray()),this.program=((t,e,i)=>{var r=t.createProgram(),a=(t.attachShader(r,e),t.attachShader(r,i),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS));if(a)return r;throw"program failed to link:"+t.getProgramInfoLog(r)})(this.gl,e(this.gl,`#version 300 es
precision lowp float;precision lowp int;out highp vec2 texcoord;void main(){const lowp vec2 l[4]=vec2[4](vec2(-1),vec2(1,-1),vec2(1),vec2(-1,1));texcoord=vec2(l[gl_VertexID].xy*.5f+.5f);texcoord.y=1.f-texcoord.y;gl_Position=vec4(l[gl_VertexID],0,1);}`,this.gl.VERTEX_SHADER),e(this.gl,`#version 300 es
precision highp float;precision highp int;precision highp sampler2D;precision highp usampler2D;in highp vec2 texcoord;uniform highp sampler2D img_rgb,img_a;layout(location=0) out highp vec4 fragColor;uniform vec2 rxy,gxy,bxy,wxy;uniform float gamma;void main(){mat3x3 h=transpose(mat3x3(vec3(rxy,1.f-rxy.x-rxy.y),vec3(gxy,1.f-gxy.x-gxy.y),vec3(bxy,1.f-bxy.x-bxy.y)));vec3 v=vec3(wxy,1.f-wxy.x-wxy.y)/wxy.y*inverse(h);for(uint f=0u;f<3u;f++)for(uint u=0u;u<3u;u++)h[u][f]*=v[f];fragColor=vec4(pow(texture(img_rgb,texcoord.xy).xyz*mat3x3(.4124564,.3575761,.1804375,.2126729,.7151522,.072175,.0193339,.119192,.9503041)*inverse(h),vec3(1.f/gamma)),texture(img_a,texcoord.xy).x);}`,this.gl.FRAGMENT_SHADER))}setCorrection(t){return this.correction=Object.assign({...r},t),this}image(t,e=0){0==e&&(this.width=t.width,this.height=t.height),this.gl.unpackColorSpace="srgb";let i=this.gl.RGB8;1==e&&(this.gl.unpackColorSpace="srgb",i=this.gl.R8);var r=this.gl.createTexture();return this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texImage2D(this.gl.TEXTURE_2D,0,i,m(this.gl,i),a(this.gl,i),t),this}fbo(t=null){return t??=this.gl.RGBA8,this.gl.activeTexture(this.gl.TEXTURE0+15),this.gl.bindTexture(this.gl.TEXTURE_2D,this.output=this.gl.createTexture()),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.clearBufferfv(this.gl.COLOR,0,[0,0,0,0]),this.gl.texImage2D(this.gl.TEXTURE_2D,0,t,this.width,this.height,0,m(this.gl,t),a(this.gl,t),null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fb=this.gl.createFramebuffer()),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.output,0),this}onCanvas(){return this.resize(this.width,this.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.colorSpace=i,this.gl.drawingBufferColorSpace=i,this.gl?.drawingBufferStorage?.(this.gl.RGBA16F,this.width,this.height),this}async gen(){this.gl.viewport(0,0,this.width,this.height),this.gl.clearBufferfv(this.gl.COLOR,0,[0,0,0,0]),this.gl.disable(this.gl.BLEND);var t=await this.program;return this.gl.useProgram(t),this.gl.uniform1i(this.gl.getUniformLocation(t,"img_rgb"),0),this.gl.uniform1i(this.gl.getUniformLocation(t,"img_a"),1),this.gl.uniform1f(this.gl.getUniformLocation(t,"gamma"),this.correction.gamma),this.gl.uniform2fv(this.gl.getUniformLocation(t,"rxy"),this.correction.rxy),this.gl.uniform2fv(this.gl.getUniformLocation(t,"gxy"),this.correction.gxy),this.gl.uniform2fv(this.gl.getUniformLocation(t,"bxy"),this.correction.bxy),this.gl.uniform2fv(this.gl.getUniformLocation(t,"wxy"),this.correction.wxy),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,4),this}resize(t,e){this.canvas.width=t,this.canvas.height=e}getCanvas(){return this.canvas}getImageData(t,e,i,r,a={}){var s=this.gl.getParameter(this.gl.IMPLEMENTATION_COLOR_READ_TYPE,a.internal??=this.gl.RGBA8);const h=s==this.gl.UNSIGNED_INT?new Uint32Array(i*r*4):new Uint8Array(a.buffer,a.byteOffset,i*r*4);return this.fb&&(this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,this.fb),this.gl.bindTexture(this.gl.TEXTURE_2D,this.output)),this.gl.readPixels(t,e,i,r,m(this.gl,a.internal),s,h,0),s==this.gl.UNSIGNED_INT&&(a.buffer?new Uint8Array(a.buffer,a.byteOffset,i*r*4).set(h):((s=new Uint8Array(i*r*4)).set(h),h=s)),{width:i,height:r,data:h,depth:8}}}const y=fetch("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=").then(t=>t.blob()),I={},p=new Promise(async t=>{I.filter="undefined"!=typeof CanvasFilter?new CanvasFilter([{filter:"colorMatrix",type:"matrix",values:[0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,1,0,0,0,0]}]):null;try{I.gdi=new G}catch(t){console.error(t)}t(I)});class N{constructor(t,e="IEND",i=0){this.data=null,this.view=null,this.length=i,this.name=e,this.slice=t,this.crc32=0}compile(){this.slice||(this.slice=new Uint8Array(new ArrayBuffer(this.length+4+4+4)),new Uint8Array(this.slice.buffer,this.slice.byteOffset+8,this.length).set(this.data));var t=new DataView(this.slice.buffer,this.slice.byteOffset,this.length+4+4+4);return t.setUint32(0,this.length,!1),t.setUint32(4,this.name.charCodeAt(0)|this.name.charCodeAt(1)<<8|this.name.charCodeAt(2)<<16|this.name.charCodeAt(3)<<24,!0),t.setUint32(this.length+4+4,this.crc32=((t,e)=>{let i=-1^e,r=t.length-15,a=0;for(;a<r;)i=T[t[a++]^255&i]^U[t[a++]^i>>8&255]^w[t[a++]^i>>16&255]^A[t[a++]^i>>>24]^E[t[a++]]^d[t[a++]]^u[t[a++]]^f[t[a++]]^R[t[a++]]^c[t[a++]]^g[t[a++]]^o[t[a++]]^l[t[a++]]^n[t[a++]]^h[t[a++]]^s[t[a++]];for(r+=15;a<r;)i=i>>>8^s[255&(i^t[a++])];return~i})(new Uint8Array(this.slice.buffer,this.slice.byteOffset+4,this.length+4)),!1),this}}class D{constructor(t,e=0){this.data=t,this.offset=e,this.chunks=[],this.signature=null,this.chunk=null}readSignature(){this.signature=new Uint8Array(this.data,this.offset,8),this.offset+=8,this.chunk=new N}readLength(){this.chunk||(this.chunk=new N),this.chunk.length=new DataView(this.data,this.offset,4).getUint32(0,!1),this.offset+=4}readName(){this.chunk.name=(new TextDecoder).decode(new Uint8Array(this.data,this.offset,4)),this.offset+=4}readCRC(){this.chunk.crc32=new DataView(this.data,this.offset,4).getUint32(0,!1),this.offset+=4}readData(){this.chunk.data=new Uint8Array(this.data,this.offset,this.chunk.length),this.chunk.view=new DataView(this.data,this.offset,this.chunk.length),this.offset+=this.chunk.length}makeSlice(){this.chunks.push(this.chunk),this.chunk.slice=new Uint8Array(this.data,this.offset-this.chunk.length-4-4-4,this.chunk.length+4+4+4),this.chunk=new N}}class _{constructor(t,e){this.PNGsignature=new Uint8Array([137,80,78,71,13,10,26,10]),this.idats=t.filter(t=>"IDAT"==t.name),this.chunks=[],this.header=e}encodePLTE(){var t=new N,e=3*(1<<this.header.bitDepth),i=new ArrayBuffer(4+e+4+4);return t.length=e,t.name="PLTE",t.data=new Uint8Array(i,8,e),t.view=new DataView(i,8,e),t.data.set(new Uint8Array(e).fill(255)),t.slice=new Uint8Array(i),this.chunks.push(t.compile()),this}encodeTRNS(){var t=new N,e=1<<this.header.bitDepth,i=new ArrayBuffer(4+e+4+4);return t.length=e,t.name="tRNS",t.data=new Uint8Array(i,8,e),t.view=new DataView(i,8,e),t.data.set(new Uint8Array(e).map((t,e)=>e<<8-this.header.bitDepth)),t.slice=new Uint8Array(i),this.chunks.push(t.compile()),this}encodeIHDR(){var t=new N,e=new ArrayBuffer(25);return t.length=13,t.name="IHDR",t.data=new Uint8Array(e,8,13),t.view=new DataView(e,8,13),t.view.setUint32(0,this.header.width,!1),t.view.setUint32(4,this.header.height,!1),t.view.setUint8(8,this.header.bitDepth,!1),t.view.setUint8(9,0,!1),t.view.setUint8(10,0,!1),t.view.setUint8(11,this.filter,!1),t.view.setUint8(12,this.interlace,!1),t.slice=new Uint8Array(e),this.chunks.splice(0,0,t.compile()),this}encodeIEND(){var t=new N,e=new ArrayBuffer(12);return t.length=0,t.slice=new Uint8Array(e),t.name="IEND",this.chunks.push(t.compile()),this}encode(){return this.encodeIHDR(),this.chunks.push(...this.idats),this.encodeIEND(),new Blob([this.PNGsignature,...this.chunks.map(t=>t.slice)],{type:"image/png"})}}export default class{#header={};#JNGSignature=new Uint8Array([139,74,78,71,13,10,26,10]);#alphaHeader={};#A=null;#RGB=null;#options={};#correction={};#result=null;#URL="";#DIR="";#reader=null;#module=null;constructor(t){this.#JNGSignature=new Uint8Array([139,74,78,71,13,10,26,10]),this.#header={width:0,height:0,bitDepth:8},this.#alphaHeader={width:0,height:0,bitDepth:8,filter:0,compression:0,interlace:0},this.#A=null,this.#RGB=null,this.#options={...t},this.#correction={},this.#result=null}async#load(e,t){"string"==typeof e&&(e=(e=e.trim()||"").startsWith(".")?location.origin+"/"+e:e).startsWith("/")&&(e=location.origin+e),this.#URL=e,this.#DIR||=location.hostname;let i=null;try{i=(await import("indexeddb-fs")).default}catch(t){}if(i){let t=!1;try{t=await i.isDirectory(this.#DIR||=""+location.hostname.hashCode())}catch(t){}t||await i.createDirectory(this.#DIR)}if(i){let t=!1;try{t=await i.isDirectory(this.#DIR+="/framelib")}catch(t){}t||await i.createDirectory(this.#DIR)}let r=e;try{r=e instanceof Response?e:await fetch(e instanceof Blob?URL.createObjectURL(e):e,{mode:"cors",keepalive:!0})}catch(t){console.log(e),console.error(t)}var a,s=e instanceof Blob?e:r.ok?await r.blob():null;const h=new FileReader;return r.ok?(a=new Promise((t,e)=>{h.onload=t,h.onerror=e}),h.readAsArrayBuffer(s),await a,t(h.result,s)):(this.#reader=null,console.error("URL: "+e+", Error HTTP: "+r.status),s)}#concat(t,...e){let i=0;for(var r of e)i+=r.length;var a,s=new t(i);let h=0;for(a of e)s.set(a,h),h+=a.length;return s}#compare(t,e){for(let i=t.length;-1<i;--i)if(t[i]!==e[i])return!1;return!0}#equal32(t,e){var i=new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4),r=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);return this.#compare(i,r)}#checkSignature(){return this.#equal32(this.#reader.signature,this.#JNGSignature)}#readBody(){for(;this.#reader.offset<this.#reader.data.byteLength&&(this.#reader.readLength(),this.#reader.readName(),this.#reader.readData(),this.#reader.readCRC(),this.#reader.makeSlice(),"IEND"!=this.#reader.chunks.slice(-1)[0].name););var t=this.#reader.chunks.find(t=>"cHRM"==t.name),e=this.#reader.chunks.find(t=>"gAMA"==t.name);return t&&(this.#correction.wxy=new Float32Array([t.view.getUint32(0,!1)/1e5,t.view.getUint32(4,!1)/1e5]),this.#correction.rxy=new Float32Array([t.view.getUint32(8,!1)/1e5,t.view.getUint32(12,!1)/1e5]),this.#correction.gxy=new Float32Array([t.view.getUint32(16,!1)/1e5,t.view.getUint32(20,!1)/1e5]),this.#correction.bxy=new Float32Array([t.view.getUint32(24,!1)/1e5,t.view.getUint32(28,!1)/1e5])),e&&(this.#correction.gamma=e.view.getUint32(0,!1)/1e5),this.#readHeader(),this.#RGB=this.#concatJDAT(),8==this.#alphaHeader.compression&&0<this.#alphaHeader.bitDepth||this.#reader.chunks.find(t=>"JDAA"==t.name||"JdAA"==t.name)?this.#A=this.#concatJDAA():(0==this.#alphaHeader.compression&&0<this.#alphaHeader.bitDepth||this.#reader.chunks.find(t=>"IDAT"==t.name))&&(this.#A=this.#reconstructPNG()),this}#readImage(){return this.#reader.readSignature(),this.#checkSignature()?this.#readBody():this.#reader=null,this}#readHeader(){var t=this.#reader.chunks.find(t=>"JHDR"===t.name);this.#alphaHeader.width=this.#header.width=t.view.getUint32(0,!1),this.#alphaHeader.height=this.#header.height=t.view.getUint32(4,!1),this.#alphaHeader.bitDepth=t.view.getUint8(12,!1),this.#alphaHeader.compression=t.view.getUint8(13,!1),this.#alphaHeader.filter=t.view.getUint8(14,!1),this.#alphaHeader.interlace=t.view.getUint8(15,!1)}async asPNG(){return(await this.#combine()).getCanvas().convertToBlob({type:"image/png"})}async asCanvas(){return(await this.#combine()).getCanvas()}async load(t){return this.#load(t,async(t,e)=>(this.#reader=new D(t),this.#readImage(),this.#reader?this.asPNG():e))}#loadInternal(t){return this.#reader=t,this.readBody(),this.recodePNG()}#reconstructPNG(){return new _(this.#reader.chunks,this.#alphaHeader).encode()}#concatJDAT(){var t=this.#reader.chunks.filter(t=>"JDAT"==t.name).map(t=>t.data);return new Blob(t,{type:"image/jpeg"})}#concatJDAA(){var t=this.#reader.chunks.filter(t=>"JDAA"==t.name||"JdAA"==t.name).map(t=>t.data);return new Blob(t,{type:"image/jpeg"})}#combine(){return(async()=>Promise.all([createImageBitmap(this.#RGB,{colorSpaceConversion:"none",resizeQuality:"pixelated"}),createImageBitmap(this.#A||await y,{colorSpaceConversion:"none",resizeQuality:"pixelated"}),new Promise(async t=>t(this.#module??=await p))]))().then(t=>t[2].gdi.image(t[0],0).image(t[1],1).setCorrection(this.#correction).onCanvas().gen())}}